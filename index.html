<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>æ¯æ—¥ä½“é‡ãƒ¡ãƒ¢ â€” ã‚°ãƒ©ãƒ•ï¼†XæŠ•ç¨¿</title>
<meta name="description" content="ä½“é‡ã‚’æ¯æ—¥ã‚µã‚¯ãƒƒã¨è¨˜éŒ²ã€‚ç›´è¿‘60æ—¥ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã¨ã€Xï¼ˆTwitterï¼‰ã«ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—æŠ•ç¨¿ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚">
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#fff;--fg:#0f172a;--muted:#6b7280;--card:#f8fafc;--border:#e5e7eb;--accent:#2563eb;--accent-weak:#dbeafe;--danger:#ef4444;
  }
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b0f14;--fg:#e5e7eb;--muted:#9ca3af;--card:#0f1720;--border:#1f2937;--accent:#60a5fa;--accent-weak:#0b274a;--danger:#f87171;}
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  h1{font-size:1.25rem;margin:8px 0 2px}
  p.lead{margin:0;color:var(--muted);font-size:.9rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin:14px 0}
  label{font-size:.9rem;color:var(--muted)}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:var(--fg)}
  input[type="date"]{padding:10px 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .btn{display:inline-block;text-align:center;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--fg);font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn-ghost{background:var(--card)}
  .tiny{font-size:.8rem;color:var(--muted)}
  canvas{width:100%;height:120px;display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px solid var(--border);font-size:.95rem}
  th{text-align:left;color:var(--muted)}
  td.right{text-align:right}
  tr:hover{background:rgba(125,125,125,.06)}
  footer{text-align:center;margin:18px 0 40px;color:var(--muted)}
  #footer a{color:var(--accent);font-weight:700;text-decoration:none}
  .badge{border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:.75rem}
  .badge.up{color:#16a34a;border-color:#16a34a}
  .badge.down{color:var(--danger);border-color:var(--danger)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>æ¯æ—¥ä½“é‡ãƒ¡ãƒ¢ âš–ï¸</h1>
      <p class="lead">ä½“é‡ã ã‘ã‚’ã‚µã‚¯ãƒƒã¨è¨˜éŒ² â†’ ã‚°ãƒ©ãƒ• â†’ Xã«æŠ•ç¨¿ã€‚</p>
    </header>

    <!-- å…¥åŠ› -->
    <section class="card">
      <div class="grid">
        <div>
          <label for="date">æ—¥ä»˜</label>
          <input type="date" id="date">
        </div>
        <div>
          <label for="weight">ä½“é‡ (kg)</label>
          <input type="number" id="weight" inputmode="decimal" step="0.1" placeholder="ä¾‹: 68.5">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn btn-primary grow" id="saveBtn">ä¿å­˜ / æ›´æ–°</button>
        <button class="btn btn-ghost" id="clearBtn">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="tiny" id="hint"></div>
    </section>

    <!-- ã‚°ãƒ©ãƒ• -->
    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <div><strong>ç›´è¿‘60æ—¥ã®æ¨ç§»</strong></div>
        <div class="badge" id="trendBadge">Â±0.0kg / 7æ—¥</div>
      </div>
      <canvas id="chart"></canvas>
      <div class="tiny" id="stats">å¹³å‡: - / æœ€å°: - / æœ€å¤§: -</div>
    </section>

    <!-- å±¥æ­´ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <strong>å±¥æ­´</strong>
        <div class="row">
          <button class="btn" id="shareBtn" title="Xï¼ˆTwitterï¼‰ã«æŠ•ç¨¿">Xã«æŠ•ç¨¿</button>
          <button class="btn" id="csvBtn" title="CSVå‡ºåŠ›">CSV</button>
          <button class="btn" id="delAllBtn" style="color:var(--danger)">å…¨å‰Šé™¤</button>
        </div>
      </div>
      <div style="overflow-x:auto;margin-top:8px;">
        <table>
          <thead><tr><th>æ—¥ä»˜</th><th class="right">ä½“é‡</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="tbody"><!-- JSã§æç”» --></tbody>
        </table>
      </div>
      <p class="tiny">è¡Œã‚’ã‚¿ãƒƒãƒ—ã§ãƒ•ã‚©ãƒ¼ãƒ ã¸èª­ã¿è¾¼ã¿ï¼å‰Šé™¤ã¯å³ã®ãƒœã‚¿ãƒ³ã€‚</p>
    </section>

    <footer>
      <div class="tiny">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚</div>
      <div id="footer">
        X <a href="https://x.com/kkp_webninja" target="_blank">@kkp_webninja</a><br>
        ğŸ¯ <a href="https://kkpwebninja.com" target="_blank">webå¿è€…ã®æœ¬ä¸¸</a><br>
      </div>
    </footer>
  </div>

<script>
/* ===========================
  æ¯æ—¥ä½“é‡ãƒ¡ãƒ¢ â€” å®Ÿè£…æ¦‚è¦
  - localStorageã‚­ãƒ¼: "weights"
  - ãƒ¬ã‚³ãƒ¼ãƒ‰: {date:"YYYY-MM-DD", weight:æ•°å€¤, id:UUID}
  - ä¸»æ©Ÿèƒ½: è¿½åŠ /æ›´æ–°, å±¥æ­´ä¸€è¦§, ã‚­ãƒ£ãƒ³ãƒã‚¹æŠ˜ã‚Œç·š, 7æ—¥å¤‰åŒ–, Xå…±æœ‰, CSV
===========================*/

// ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const todayStr = ()=> new Date().toISOString().slice(0,10);
const uuid = ()=> (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random());
const num = v => { const n = Number(v); return isNaN(n)? null : n; };
const fmt = (x, d=1) => (x==null? "-" : Number(x).toFixed(d));

// ---- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ----
const load = ()=> { try{return JSON.parse(localStorage.getItem("weights")||"[]");}catch{return[]} };
const save = arr => localStorage.setItem("weights", JSON.stringify(arr));

// ---- è¦ç´  ----
const dateEl   = $("#date");
const weightEl = $("#weight");
const hintEl   = $("#hint");
const tbody    = $("#tbody");
const trendEl  = $("#trendBadge");
const statsEl  = $("#stats");
const canvas   = $("#chart");

// åˆæœŸæ—¥ä»˜
dateEl.value = todayStr();

// æ—¢å­˜ãŒã‚ã‚Œã°ä»Šæ—¥ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«
const initToday = ()=>{
  const r = load().find(r=>r.date===dateEl.value);
  if (r) weightEl.value = r.weight;
};
initToday();

// ---- ä¿å­˜/æ›´æ–° ----
$("#saveBtn").addEventListener("click", ()=>{
  const d = dateEl.value || todayStr();
  const w = num(weightEl.value);
  if (w==null){ hint("ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

  const arr = load();
  const idx = arr.findIndex(r=>r.date===d);
  if (idx>=0) arr[idx] = {...arr[idx], weight:w};
  else arr.push({id:uuid(), date:d, weight:w});
  arr.sort((a,b)=> a.date<b.date?1:-1); // æ–°ã—ã„é †
  save(arr);

  renderTable(); renderChart(); updateBadges();
  hint("ä¿å­˜ã—ã¾ã—ãŸã€‚");
});

// å…¥åŠ›ã‚¯ãƒªã‚¢
$("#clearBtn").addEventListener("click", ()=>{
  weightEl.value = "";
});

// æ—¥ä»˜å¤‰æ›´ã§èª­è¾¼
dateEl.addEventListener("change", ()=>{
  const r = load().find(r=>r.date===dateEl.value);
  weightEl.value = r? r.weight : "";
});

// ---- å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« ----
function renderTable(){
  const arr = load();
  tbody.innerHTML = "";
  for (const r of arr){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="pick" data-id="${r.id}" style="cursor:pointer">${r.date}</td>
      <td class="right">${fmt(r.weight)}</td>
      <td><button class="btn tinyDel" data-id="${r.id}" style="padding:6px 10px;color:var(--danger)">å‰Šé™¤</button></td>
    `;
    tbody.appendChild(tr);
  }
}
tbody.addEventListener("click", (e)=>{
  const del = e.target.closest(".tinyDel")?.dataset.id;
  if (del){
    if (confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
      const arr = load().filter(x=>x.id!==del);
      save(arr); renderTable(); renderChart(); updateBadges();
    }
    return;
  }
  const pick = e.target.closest(".pick")?.dataset.id;
  if (pick){
    const r = load().find(x=>x.id===pick);
    if (r){ dateEl.value = r.date; weightEl.value = r.weight; }
  }
});

// å…¨å‰Šé™¤
$("#delAllBtn").addEventListener("click", ()=>{
  if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem("weights");
  renderTable(); renderChart(); updateBadges();
});

// ---- ã‚°ãƒ©ãƒ•ï¼ˆè‡ªå‰Canvasï¼‰ ----
function renderChart(){
  const ctx = canvas.getContext("2d");
  const w = canvas.clientWidth * devicePixelRatio;
  const h = 120 * devicePixelRatio;
  canvas.width = w; canvas.height = h;
  ctx.clearRect(0,0,w,h);

  const rec = load().slice().reverse(); // å¤â†’æ–°
  const data = rec.slice(-60);          // ç›´è¿‘60ä»¶
  if (!data.length){
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--muted");
    ctx.font = `${12*devicePixelRatio}px system-ui`;
    ctx.fillText("è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“", 8*devicePixelRatio, 64*devicePixelRatio);
    statsEl.textContent = "å¹³å‡: - / æœ€å°: - / æœ€å¤§: -";
    return;
  }

  const vals = data.map(d=>d.weight);
  const min = Math.min(...vals), max = Math.max(...vals);
  const pad = 8*devicePixelRatio;
  const xStep = (w - pad*2) / Math.max(1, data.length-1);
  const yScale = (h - pad*2) / ((max-min)||1);

  // å¹³å‡ã‚¬ã‚¤ãƒ‰
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
  ctx.strokeStyle = "rgba(125,125,125,0.3)";
  ctx.setLineDash([4*devicePixelRatio,4*devicePixelRatio]);
  ctx.beginPath();
  const yAvg = h - pad - (avg-min)*yScale;
  ctx.moveTo(pad, yAvg); ctx.lineTo(w-pad, yAvg); ctx.stroke();
  ctx.setLineDash([]);

  // æŠ˜ã‚Œç·š
  ctx.lineWidth = 2*devicePixelRatio;
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--accent");
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x = pad + i*xStep;
    const y = h - pad - (d.weight-min)*yScale;
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // çµ±è¨ˆ
  statsEl.textContent = `å¹³å‡: ${fmt(avg)} / æœ€å°: ${fmt(min)} / æœ€å¤§: ${fmt(max)}`;
}

// ãƒªã‚µã‚¤ã‚ºã§å†æç”»ï¼ˆå‘ãå¤‰æ›´å¯¾ç­–ï¼‰
addEventListener("resize", renderChart);

// ---- 7æ—¥å¤‰åŒ–ï¼†XæŠ•ç¨¿ ----
function lastNDaysChange(n=7){
  const arr = load().slice().reverse(); // å¤â†’æ–°
  if (arr.length===0) return null;
  // næ—¥ä»¥ä¸Šå‰ã®æœ€ã‚‚è¿‘ã„è¨˜éŒ²ã¨ã€æœ€æ–°
  const latest = arr[arr.length-1];
  const base   = arr.find(d=>{
    const diff = (new Date(latest.date) - new Date(d.date)) / 86400000;
    return diff >= n-0.5; // ã‚†ã‚‹ã7æ—¥å‰ç›¸å½“
  }) || arr[0];
  return { latest, base, diff: latest.weight - base.weight };
}

function updateBadges(){
  const ch = lastNDaysChange(7);
  if (!ch){ trendEl.textContent = "Â±0.0kg / 7æ—¥"; trendEl.className="badge"; return; }
  const sign = ch.diff>0 ? "+" : "";
  trendEl.textContent = `${sign}${fmt(ch.diff)}kg / 7æ—¥`;
  trendEl.className = "badge " + (ch.diff<=0 ? "up" : "down");
}

// Xã«æŠ•ç¨¿ï¼šintentã‚’é–‹ãï¼ˆæœ¬æ–‡ã¯ç·¨é›†å¯èƒ½ï¼‰
$("#shareBtn").addEventListener("click", ()=>{
  const arr = load().slice().sort((a,b)=> a.date<b.date?1:-1); // æ–°â†’æ—§
  if (!arr.length){ hint("æŠ•ç¨¿ã™ã‚‹ã«ã¯ã€ã¾ãšä½“é‡ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"); return; }
  const today = arr[0];
  const ch = lastNDaysChange(7);
  const arrow = ch ? (ch.diff<0 ? "â†˜ï¸" : (ch.diff>0 ? "â†—ï¸" : "â¡ï¸")) : "";
  const change = ch ? `${ch.diff>0?"+":""}${fmt(ch.diff)}kgï¼ˆ7æ—¥ï¼‰` : "Â±0.0kgï¼ˆ7æ—¥ï¼‰";

  // ã“ã“ã¯å…¬é–‹URLã«å·®ã—æ›¿ãˆæ¨å¥¨ï¼ˆä¾‹: https://weight.kkpwebninja.com/ï¼‰
  const myUrl = "https://kkpwebninja.com/";
  const text = `ä»Šæ—¥ã®ä½“é‡ ${today.weight}kgï¼ˆ${today.date}ï¼‰ ${arrow}\n${change}\n#ä½“é‡è¨˜éŒ² #ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ`;
  const url = "https://twitter.com/intent/tweet?text="+encodeURIComponent(text)+"&url="+encodeURIComponent(myUrl);
  window.open(url, "_blank", "noopener,noreferrer");
});

// CSVå‡ºåŠ›
$("#csvBtn").addEventListener("click", ()=>{
  const arr = load().slice().sort((a,b)=> a.date<b.date? -1:1); // å¤â†’æ–°
  if (!arr.length){ hint("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
  const head = "date,weight\n";
  const body = arr.map(r=>`${r.date},${r.weight}`).join("\n");
  const blob = new Blob([head+body], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "weights.csv"; a.click();
  URL.revokeObjectURL(url);
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function hint(msg){ hintEl.textContent = msg; setTimeout(()=> hintEl.textContent="", 1500); }

// åˆæœŸæç”»
function init(){ renderTable(); renderChart(); updateBadges(); }
init();
</script>
</body>
</html>
